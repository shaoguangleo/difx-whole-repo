<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>DiFX Python Interface: How to Use the Interface</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DiFX Python Interface
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="modules.html"><span>Example&#160;Programs</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Topics</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('howToUse.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">How to Use the Interface </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#theDifxServer">The DiFX Server to Your Python Client</a><ul><li class="level2"><a href="#runningGuiServer">Running guiServer</a></li>
</ul>
</li>
<li class="level1"><a href="#makingClientConnection">Making a Client Connection</a><ul><li class="level2"><a href="#closing">Closing the Client Connection</a></li>
</ul>
</li>
<li class="level1"><a href="#runningTheMonitor">Monitoring Communications from the Server</a><ul><li class="level2"><a href="#whatThe">Why Doesn&#39;t the Client Monitor Automatically?</a></li>
<li class="level2"><a href="#relayPackets">Collecting Relayed DiFX Communication</a></li>
</ul>
</li>
<li class="level1"><a href="#environment">Viewing (and Changing) Your DiFX Run Environment</a><ul><li class="level2"><a href="#Using">Different DiFX Versions</a></li>
</ul>
</li>
<li class="level1"><a href="#simpleOperations">Performing Simple File Operations</a><ul><li class="level2"><a href="#simpleCommands">Simple Operations: mv, rm, mkdir, rmdir</a></li>
<li class="level2"><a href="#lsOperation">The ls Command</a></li>
</ul>
</li>
<li class="level1"><a href="#feedback">Collecting Information Provided by Running Processes</a></li>
<li class="level1"><a href="#fileTransfer">Transfering File Data Between Client and Server</a></li>
<li class="level1"><a href="#messages">Monitoring DiFX Messages</a></li>
<li class="level1"><a href="#creatingJobs">Creating New Jobs</a></li>
<li class="level1"><a href="#jobControl">Starting, Stopping and Monitoring DiFX Jobs</a><ul><li class="level2"><a href="#jobControl_inputFile">Identifying a Job Using the .input File</a></li>
<li class="level2"><a href="#jobControl_machines">Defining Data Sources and Processors</a></li>
<li class="level2"><a href="#jobControl_start">Running a Job and Monitoring Progress</a><ul><li class="level3"><a href="#monitor_progress">How Can I See What is Going On?</a></li>
</ul>
</li>
<li class="level2"><a href="#jobControl_stop">Stopping a Running Job</a></li>
<li class="level2"><a href="#jobControl_monitor">Monitoring the Data Output of a Running Job</a></li>
</ul>
</li>
<li class="level1"><a href="#jobHistory">Obtaining the Run History of a Job</a></li>
<li class="level1"><a href="#vsnStuff">Mark5-Specific Operations</a><ul><li class="level2"><a href="#vsnStuff_mk5">Sending a Mark5 Command</a></li>
<li class="level2"><a href="#vsnStuff_directory">Obtaining the Directory of a Mark5 Module</a></li>
<li class="level2"><a href="#vsnStuff_filelist">Generating a New Mark5 &quot;File List&quot;</a></li>
<li class="level2"><a href="#vsnStuff_copy">Copying Data from a Mark5 Module</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>Instructions and Code Snippets Showing How to Use the DiFX Python Interface</p>
<p>This document outlines how to use the DiFX Python Interface with Python coding examples. Most of this code is swiped directly of the Example Programs - when and from where will be noted in the text.</p>
<h1><a class="anchor" id="theDifxServer"></a>
The DiFX Server to Your Python Client</h1>
<p>The DiFX software package is primarily a collection of stand-alone processes originally designed to be run individually from the command line. These processes communicate with each other to some degree, but there is no overall "controlling" process that runs them all.</p>
<p>The <em>guiServer</em> process was created as a server for DiFX GUI clients. Using a simple communications protocol based on one or more TCP connections, <em>guiServer</em> acts on instructions from the GUI to execute different DiFX processes (often using <em>system()</em> commands) and reports their results. The Python DiFX Interface utilizes this same protocol, appearing to <em>guiServer</em> like a GUI client.</p>
<p>As a consequence of this arrangement, <em>guiServer</em> must be running for the DiFX Python Interface to work.</p>
<h2><a class="anchor" id="runningGuiServer"></a>
Running guiServer</h2>
<p>The <em>guiServer</em> process is part of the DiFX source tree. It is a C++ program that must be run on a system and under a user that has access to all data required for DiFX work, write permission in locations where DiFX processes need to write things, and execute permission for all DiFX processes as well as <em>mpirun</em>.</p>
<p>The best place to run <em>guiServer</em> is on the "head node" of your DiFX cluster, using whatever user name you would use to run a DiFX process by hand (in the following examples this user will be called "oper"). Assuming your DiFX environment variables have been set up properly, <em>guiServer</em> should run from the command line. It will respond with the port number at which clients can connect.</p>
<pre>
    oper DIFX-DEVEL ~&gt; guiServer
    server at port 50200
    guiServer: wait for new client connection
</pre><p>Alternatively you can specify the port number you want:</p>
<pre>
    oper DIFX-DEVEL ~&gt; guiServer 50400
    server at port 50400
    guiServer: wait for new client connection
</pre><h1><a class="anchor" id="makingClientConnection"></a>
Making a Client Connection</h1>
<p>Before doing anything, the DiFX Python Interface must make a client connection to <em>guiServer</em>. This is done using an instance of the <a class="el" href="classDiFXControl_1_1Client.html" title="Class for creating and manipulating a client connection to the DiFX server. ">DiFXControl.Client</a> class. The <em>connect()</em> method is used to make the connection. It has two, optional arguments - a string containing the name of the host where <em>guiServer</em> is running (as it is addressed from where the client is running) and an integer representing the port number provided by <em>guiServer</em>.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;import DiFXControl</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;difx = <a class="code" href="classDiFXControl_1_1Client.html">DiFXControl.Client</a>()</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;difx.connect( <span class="stringliteral">&quot;headnode.difxcluster&quot;</span>, 50400 )</div>
</div><!-- fragment --><p>Your <em>guiServer</em> session will respond to this with the following (or something similar):</p>
<pre>
    guiServer: client connection from address 127.0.0.1
    guiServer: wait for new client connection
</pre><p>If the hostname or port is not provided, or is set to <code>None</code>, the <em>connect()</em> method will employ some defaults. If the hostname is not provided, it will use the value of the environment variable "DIFX_CONTROL_HOST". Failing that, it will guess the hostname is "localhost". If the port is omitted, the environment variables "DIFX_CONTROL_PORT" and "DIFX_MESSAGE_PORT" will be used, with 50401 serving as the final default of they don't exist.</p>
<h2><a class="anchor" id="closing"></a>
Closing the Client Connection</h2>
<p>When you are done with a client connection, it is best to close it. This is done with the <em>close()</em> method:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">import</span> DiFXControl</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;difx = <a class="code" href="classDiFXControl_1_1Client.html">DiFXControl.Client</a>()</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;difx.connect( <span class="stringliteral">&quot;headnode.difxcluster&quot;</span>, 50400 )</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;difx.close()</div>
</div><!-- fragment --><p>The <em>guiServer</em> session will respond with:</p>
<pre>
    127.0.0.1 disconnected
</pre><h1><a class="anchor" id="runningTheMonitor"></a>
Monitoring Communications from the Server</h1>
<p>The client connection to <em>guiServer</em> is two-way - in addition to allowing commands to be sent to the server, it allows the server to send data back (the server can also be set to relay the UDP communications between DiFX processes - see DiFX UDP Messages). Nominally the client ignores this communication, but the <em>monitor()</em> function can be used to start a <a class="el" href="classDiFXControl_1_1MonitorThread.html" title="Thread to monitor a socket from the DiFX server. ">DiFXControl.MonitorThread</a> that consumes and appropriately distributes it.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">import</span> DiFXControl</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;difx = <a class="code" href="classDiFXControl_1_1Client.html">DiFXControl.Client</a>()</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;difx.connect( <span class="stringliteral">&quot;headnode.difxcluster&quot;</span>, 50400 )</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;difx.monitor()</div>
</div><!-- fragment --><h2><a class="anchor" id="whatThe"></a>
Why Doesn't the Client Monitor Automatically?</h2>
<p>It would appear that monitoring communicaiton from the server is something the client would always want to do, which begs the question: why require the user to run the <em>monitor()</em> function by hand - why not just make it part of the <em>connect()</em> function?</p>
<p>The reason is the <a class="el" href="classDiFXControl_1_1MonitorThread.html" title="Thread to monitor a socket from the DiFX server. ">DiFXControl.MonitorThread</a> runs a <em>select()</em> on the TCP socket to respond to incoming data. There are times when you might want to run your own <em>select()</em> on the socket, and the <a class="el" href="classDiFXControl_1_1MonitorThread.html" title="Thread to monitor a socket from the DiFX server. ">DiFXControl.MonitorThread</a> would mess things up. At the same time, you might want some of the functionality of the <a class="el" href="classDiFXControl_1_1MonitorThread.html" title="Thread to monitor a socket from the DiFX server. ">DiFXControl.MonitorThread</a> - its ability to interpret the <em>guiServer</em> packet protocol and trigger callbacks for instance. For these purposes there is a <em>passiveMonitor()</em> method which creates an instance of <a class="el" href="classDiFXControl_1_1MonitorThread.html" title="Thread to monitor a socket from the DiFX server. ">DiFXControl.MonitorThread</a> but doesn't start it. If you wish to do your own <em>select()</em>, the <a class="el" href="classDiFXControl_1_1Client.html" title="Class for creating and manipulating a client connection to the DiFX server. ">DiFXControl.Client</a> <em>sock</em> variable gives you access to the TCP socket.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">import</span> DiFXControl</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">import</span> select</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;difx = <a class="code" href="classDiFXControl_1_1Client.html">DiFXControl.Client</a>()</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;difx.connect( <span class="stringliteral">&quot;headnode.difxcluster&quot;</span>, 50400 )</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;difx.passiveMonitor()</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">#  Run select yourself</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;iwtd, owtd, ewtd = select.select( [difx.sock], [], [], .05 )</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">#  Do stuff...</span></div>
</div><!-- fragment --><h2><a class="anchor" id="relayPackets"></a>
Collecting Relayed DiFX Communication</h2>
<p>A particular type of server-to-client communication is the relay of DiFX UDP packets. Many of the DiFX processes use UDP broadcasts to report progress or status, and these packets can be intercepted by <em>guiServer</em> and relayed to the Python Interface. This topic is complex enough that it is given its own section: DiFX UDP Messages.</p>
<h1><a class="anchor" id="environment"></a>
Viewing (and Changing) Your DiFX Run Environment</h1>
<p>The <a class="el" href="classDiFXControl_1_1Client.html" title="Class for creating and manipulating a client connection to the DiFX server. ">DiFXControl.Client</a> class can query <em>guiServer</em> to obtain information about its run environment that may influence how DiFX processes will be run. In response to the <a class="el" href="classDiFXControl_1_1Client.html#ad33b4a20279c9313afd364df88b5f105" title="Send a &quot;guiServer Version&quot; request. ">DiFXControl.Client.versionRequest()</a> method, <em>guiServer</em> will provide information about the user that is running it, the DiFX version it was run under and will run other DiFX processes under (not necessarily the same!), available DiFX versions, and evironment variable values. All these data will be stored in class variables.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">import</span> DiFXControl</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">import</span> time</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;difx = <a class="code" href="classDiFXControl_1_1Client.html">DiFXControl.Client</a>()</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;difx.connect( <span class="stringliteral">&quot;headnode.difxcluster&quot;</span>, 50400 )</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;difx.monitor()</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">#  Send a request for version information.  Response is threaded so give it a second</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">#  to complete.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;difx.versionRequest()</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;time.sleep( 1.0 )</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">#  Print results</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keywordflow">print</span> <span class="stringliteral">&quot;Server version:                   &quot;</span> + str( difx.serverVersion )</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keywordflow">print</span> <span class="stringliteral">&quot;DiFX will be run by user:         &quot;</span> + str( difx.serverUser )</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="keywordflow">print</span> <span class="stringliteral">&quot;DiFX will run using version:      &quot;</span> + str( difx.versionPreference )</div>
</div><!-- fragment --><p>The environment variables are stored as a dictionary list, where the environment variable name is the key to its value. Here we print out the entire list which might be pretty long.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  Print the environment variables seen by guiServer.</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keywordflow">for</span> key <span class="keywordflow">in</span> difx.serverEnvironment.keys():</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    <span class="keywordflow">print</span> key + <span class="stringliteral">&quot; = &quot;</span> + difx.serverEnvironment[key]</div>
</div><!-- fragment --><h2><a class="anchor" id="Using"></a>
Different DiFX Versions</h2>
<p>Depending on how DiFX is installed on your system, you may have access to multiple versions of the software. There are occasionally reasons why you would wish to run using one version or another. <em>GuiServer</em> can run all DiFX processes using any available version as long as a specific structure is in place (this structure is installed automatically as part of the <a href="https://safe.nrao.edu/wiki/bin/view/HPC/UsnoDifxInstallation">difxbuild</a> process, and possibly other installation procedures).</p>
<p>For <em>guiServer</em> to run a given version, it must have access to a "rungeneric" file. These are scripts stored in the path: </p><pre>
$DIFX_BASE/bin/rungeneric.{VERSION_NAME}
</pre><p> Each script sets up all required environment variables and whatever else needs to be done to execute a DiFX process using the given DiFX version. <em>GuiServer</em> runs DiFX processes through the script. For instance, to run the DiFX process <em>vex2difx</em> using version DIFX-DEVEL, <em>guiServer</em> will do the following: </p><pre>
$DIFX_BASE/bin/rungeneric.DIFX_DEVEL vex2difx [args]
</pre><p>This structure is a complexity, but it allows <em>guiServer</em> to run any version of DiFX that you have installed, and to switch between them with ease. And you don't have to use it - <em>guiServer</em> will <em>try</em> to run this way, but if you don't have the proper "rungeneric" files in the right place, it will execute DiFX commands without any preceding script.</p>
<p><em>GuiServer</em> itself is version-dependent, but it is designed with this "version flexibility" in mind so most versions of <em>guiServer</em> should be able to run most versions of DiFX. That being said, there is no guarantee that incompatibilities will not surface at some point.</p>
<p>The <a class="el" href="classDiFXControl_1_1Client.html#ad33b4a20279c9313afd364df88b5f105" title="Send a &quot;guiServer Version&quot; request. ">DiFXControl.Client.versionRequest()</a> call allows you to see the DiFX versions that <em>guiServer</em> has access to:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  Send a version request and wait a couple of seconds for it to complete</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;difx.versionRequest()</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;time.sleep( 2.0 )</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keywordflow">if</span> len( difx.availableVersion ) &gt; 0:</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&quot;Available DiFX Versions:&quot;</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    <span class="keywordflow">for</span> ver <span class="keywordflow">in</span> difx.availableVersion:</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;        <span class="keywordflow">print</span> str( ver )</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&quot;No DiFX versions available to this server.&quot;</span></div>
</div><!-- fragment --><p>You can then set your DiFX version at any time using the <a class="el" href="classDiFXControl_1_1Client.html#a58856e891865d07d165ecc7e1d0e3eed" title="Find what versions are available on the server. ">DiFXControl.Client.version()</a> method. Any subsequent DiFX operations will use the version you set:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  Set the version to DIFX_DEVEL.</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;difx.version( <span class="stringliteral">&quot;DIFX_DEVEL&quot;</span> )</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">#  do DiFX stuff...</span></div>
</div><!-- fragment --><p>The <a class="el" href="classDiFXControl_1_1Client.html#a58856e891865d07d165ecc7e1d0e3eed" title="Find what versions are available on the server. ">DiFXControl.Client.version()</a> method also queries the available versions and will not set the version you request unless it is available.</p>
<h1><a class="anchor" id="simpleOperations"></a>
Performing Simple File Operations</h1>
<p><em>GuiServer</em> permits a limited number of simple file operations, including moving, removing, and creating new files and directories. The user running <em>guiServer</em> must have permission to run these operations for them to succeed. With the exception of <a class="el" href="howToUse.html#lsOperation">ls</a>, these operations take place (and succeed or fail) silently (although failures will produce DiFX errors that can be collected via <a class="el" href="howToUse.html#relayPackets">relayed packets</a>).</p>
<p>It should be noted that in allowing these operations <em>guiServer</em> is opening what is potentially a gaping security hole - a TCP connection without password protection is being given permission to create, move, and delete files. Argument lists to commands are terminated and limited in length, but are not examined for malicious activities. This is possibly a candidate for a future fix, but for the moment <em>guiServer</em> depends on your DiFX cluster being in a fire-walled, protected network, surrounded by friendly scientists and operators.</p>
<h2><a class="anchor" id="simpleCommands"></a>
Simple Operations: mv, rm, mkdir, rmdir</h2>
<p>The <em>mv, rm, mkdir</em> and <em>rmdir</em> commands have specific functions within the <a class="el" href="classDiFXControl_1_1Client.html" title="Class for creating and manipulating a client connection to the DiFX server. ">DiFXControl.Client</a> class that can be used to perform them. The <em>rm()</em> function accepts arguments that are passed to the <em>rm</em> command on the server, the others do not accept any arguments. The <em>mkdir</em> operation will create all missing levels of a specified path (equivalent to running "mkdir -p" on the command line).</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">import</span> DiFXControl</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;difx = <a class="code" href="classDiFXControl_1_1Client.html">DiFXControl.Client</a>()</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;difx.connect( <span class="stringliteral">&quot;headnode.difxcluster&quot;</span>, 50400 )</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">#  Make a new directory</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;difx.mkdir( <span class="stringliteral">&quot;/full/path/to/new/directory&quot;</span> )</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">#  Remove the directory</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;difx.rmdir( <span class="stringliteral">&quot;/full/path/to/undesired/directory&quot;</span> )</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">#  Remove a path (using -r argument)</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;difx.rm( <span class="stringliteral">&quot;/full/path/to/remove&quot;</span>, <span class="stringliteral">&quot;-r&quot;</span> )</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">#  Move a file</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;difx.mv( <span class="stringliteral">&quot;/full/path/of/file&quot;</span>, <span class="stringliteral">&quot;/full/path/of/destination&quot;</span> )</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;difx.close()</div>
</div><!-- fragment --><h2><a class="anchor" id="lsOperation"></a>
The ls Command</h2>
<p>The <em>ls</em> operation is slightly more complicated because it generates a response, and the response will come in an undetermined amount of time (hopefully quickly). The <a class="el" href="classDiFXControl_1_1Client.html#aacec8f633dbb8220ddea18cffa9964ae" title="Run an &quot;ls&quot; command on the server with the specified path. ">DiFXControl.Client.ls()</a> function utilizes the <a class="el" href="classDiFXls_1_1Client.html" title="Class used to do an &quot;ls&quot; on a path on the DiFX server. ">DiFXls.Client</a> class to send the <em>ls</em> command and wait for a response (the length of the wait can be set using the <a class="el" href="classDiFXControl_1_1Client.html#afe0877bac019ea92bbf8f04202ae9c60" title="Set the global wait time. ">DiFXControl.Client.waitTime()</a> method). The result of the <em>ls</em> operation is returned as a list of strings. In this example, the <em>ls</em> operation is run with the "-l" argument - <a class="el" href="classDiFXControl_1_1Client.html#aacec8f633dbb8220ddea18cffa9964ae" title="Run an &quot;ls&quot; command on the server with the specified path. ">DiFXControl.Client.ls()</a> accepts (almost) all normal <em>ls</em> arguments.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">import</span> DiFXControl</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;difx = <a class="code" href="classDiFXControl_1_1Client.html">DiFXControl.Client</a>()</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;difx.connect( <span class="stringliteral">&quot;headnode.difxcluster&quot;</span>, 50400 )</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;difx.monitor()</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;dirlist = difx.ls( <span class="stringliteral">&quot;/full/path&quot;</span>, <span class="stringliteral">&quot;-l&quot;</span> )</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keywordflow">if</span> dirlist == <span class="keywordtype">None</span>:</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&quot;No such file or directory&quot;</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;    <span class="keywordflow">for</span> item <span class="keywordflow">in</span> dirlist:</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;        <span class="keywordflow">print</span> item</div>
</div><!-- fragment --><p>While the <a class="el" href="classDiFXControl_1_1Client.html#aacec8f633dbb8220ddea18cffa9964ae" title="Run an &quot;ls&quot; command on the server with the specified path. ">DiFXControl.Client.ls()</a> is waiting, it isn't doing anything. You may wish to accomplish other things during this wait, or change the process in other ways. The <a class="el" href="classDiFXls_1_1Client.html" title="Class used to do an &quot;ls&quot; on a path on the DiFX server. ">DiFXls.Client</a> class contains code that can be taken apart and rearranged to hopefully accomplish what you wish.</p>
<h1><a class="anchor" id="feedback"></a>
Collecting Information Provided by Running Processes</h1>
<p>The DiFXContol.Client class provides a number of callback structures that allow calling programs to monitor progress or become aware of problems. They all require the same structure on the part of the calling program: </p><ol>
<li>
A function is defined to accept either zero or one arguments, depending on the callback type (see below). </li>
<li>
A callback request is added to the client. Whenever the condition associated with the callback type is encountered, a call to the callback function will be made. </li>
</ol>
<p>Below is a code example that sets up a "message" type callback.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  Define a callback function for messages.  They expect one argument (that</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">#  would be the message!)</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="keyword">def </span>myMessageCallback( argstr ):</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&quot;Hey!  You have a message: &quot;</span> + argstr</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    </div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">#  Set message callback for subsequent DiFX processes</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;difx.messageCallback( myMessageCallback )</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">#  Do DiFX Stuff</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;...</div>
</div><!-- fragment --><p>The following callback "types" follow this structure. To use them, replace the name of the type in the above code ("Message" or "message") with the name of the type you are interested in. All types may be monitored at the same time.</p>
<dl>
<dt>Message </dt>
<dd>Provides information about running processes when they are running well, triggered when something of significance happens. A string argument contains the message. </dd>
<dt>Warning </dt>
<dd>Triggered when something goes wrong in a process that (possibly) can be recovered from. Processing is continuing. A string argument contains the warning. </dd>
<dt>Error </dt>
<dd>Triggered when something goes wrong in a process that (probably) necessitates killing it. Processing is (almost always) stopping. A string argument contains the error. </dd>
<dt>Timeout </dt>
<dd>The <a class="el" href="classDiFXControl_1_1Client.html" title="Class for creating and manipulating a client connection to the DiFX server. ">DiFXControl.Client</a> class maintains a "time out" interval after which it will give up waiting for a response from the server. This function is called when that occurs. No arguments. </dd>
<dt>Interval </dt>
<dd>This is called when some milestone of partial completion of a process is passed, for example a file transfer has moved a portion of the data. No arguments are included, however the callback may indicate that there are new data settings that can be consulted to measure progress. </dd>
<dt>Final </dt>
<dd>Triggered when a process completes. There are no arguments. This callback is occasionally employed by the control classes internally, however only in methods that do not return until complete (so this shouldn't be a problem). </dd>
</dl>
<p>You can also obtain information from running processes by monitoring DiFX message traffic. This traffic is far more cluttered, but also provides considerably more detail. See the section on <a class="el" href="howToUse.html#messages">Monitoring DiFX Messages</a> for detail.</p>
<h1><a class="anchor" id="fileTransfer"></a>
Transfering File Data Between Client and Server</h1>
<p>The <a class="el" href="classDiFXFileTransfer_1_1Client.html" title="Class used to send and receive files to/from the DiFX Server. ">DiFXFileTransfer.Client</a> class can be used to obtain the contents of files on the DiFX server and to create files on the server. It inherits the <a class="el" href="classDiFXControl_1_1Client.html" title="Class for creating and manipulating a client connection to the DiFX server. ">DiFXControl.Client</a> class and can also be called from that class.</p>
<p>To get the contents of a file, the <a class="el" href="classDiFXFileTransfer_1_1Client.html#af139c5419d4447d87b3ad0c96f907746" title="Get the content of a file on the server. ">DiFXFileTransfer.Client.getFile()</a> method can be used (<a class="el" href="classDiFXControl_1_1Client.html" title="Class for creating and manipulating a client connection to the DiFX server. ">DiFXControl.Client</a> also has a method with the same name that does the same thing).</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  New instance of the client...</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;difx = <a class="code" href="classDiFXFileTransfer_1_1Client.html">DiFXFileTransfer.Client</a>()</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;difx.connect()</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;difx.monitor()</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">#  Get the file...</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;fileStr = difx.getFile( <span class="stringliteral">&quot;/full/path/to/the/file&quot;</span> )</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">#  &quot;fileStr&quot; is a string that now contains the contents of the file</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;...</div>
</div><!-- fragment --><p>Sending file content follows a similar pattern using the <a class="el" href="classDiFXFileTransfer_1_1Client.html#a3b4ed558e2d04e64398aa00426c03aef" title="Send data to a file destination on the server. ">DiFXFileTransfer.Client.sendFile()</a> method. The content is a string variable.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  Some data...</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;fileData = <span class="stringliteral">&quot;this is the file data&quot;</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">#  Send it</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;difx.sendFile( <span class="stringliteral">&quot;/full/path/to/the/newfile&quot;</span>, fileData )</div>
</div><!-- fragment --><p>The <a class="el" href="group__difxgetfile.html">DiFXgetFile</a> and <a class="el" href="group__difxsendfile.html">DiFXsendFile</a> example programs show this class is action.</p>
<h1><a class="anchor" id="messages"></a>
Monitoring DiFX Messages</h1>
<p>Many DiFX processes broadcast UDP messages when they run. The <em>guiServer</em> process collects these broadcasts and sends them, if requested, to client connections. The DiFX Python Interface can be used to gather and parse this traffic to monitor the health and performance of the DiFX cluster and running processes.</p>
<p>To collect the DiFX Message traffic, the <a class="el" href="classDiFXControl_1_1Client.html" title="Class for creating and manipulating a client connection to the DiFX server. ">DiFXControl.Client</a> class must be told to "relay" message traffic: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  New Client instance</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;difx = <a class="code" href="classDiFXControl_1_1Client.html">DiFXControl.Client</a>()</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">#  Make connection to DiFX server</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;difx.connect( ( <span class="stringliteral">&quot;localhost&quot;</span>, 50401 ) )</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">#  Start the monitor thread</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;difx.monitor()</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">#  Tell the Client to relay UDP packets</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;difx.relayPackets()</div>
</div><!-- fragment --><p>A specific callback can be defined for relay data. This function can call the <a class="el" href="namespaceDiFXControl.html#a36503727c519a2be527c90870d699bdf" title="Function to parse a DiFX message given its XML data. ">DiFXControl.parseXML</a> function, which returns a class containing the data for the DiFX Message. The class type can be determined from the <em>typeStr</em> variable of the <a class="el" href="classDiFXControl_1_1XMLMessage.html" title="Base class of DiFX Message classes. ">DiFXControl.XMLMessage</a> class (which is the base class for all of the other classes that might be returned). </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">def </span>messageCallback( self, data ):</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    <span class="comment">#  Parse the message.</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    xmlDat = <a class="code" href="namespaceDiFXControl.html#a36503727c519a2be527c90870d699bdf">DiFXControl.parseXML</a>( data )</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&quot;got message of type &quot;</span> + xmlDat.typeStr</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;        </div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;difx.addRelayCallback( messageCallback )</div>
</div><!-- fragment --><p>You can request to have only specific message types relayed (by default all are relayed). This is more efficient than collecting every message type and throwing away those you don't want because the instruction to relay a subset of messages is passed to the server, so unwanted messages never become part of the relay traffic. To do so, the <a class="el" href="classDiFXControl_1_1Client.html#a42860cd594f3d54217fdf37209fb0728" title="Select a list of messages that the server should relay. ">DiFXControl.Client.messageSelection()</a> method is passed a list of message types (in the form of strings): </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;messageTypes = []</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;messageTypes.append( <span class="stringliteral">&quot;DifxAlertMessage&quot;</span> )</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;messageTypes.append( <span class="stringliteral">&quot;DifxStatusMessage&quot;</span> )</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;difx.messageSelection( messageTypes )</div>
</div><!-- fragment --><p>All DiFX broadcast message types are defined in "difxmessage.h" in the difxmessage directory under the DiFX source tree. The following (possibly incomplete and probably not fully accurate) table lists the different message types (using the name that can be used to select them with <a class="el" href="classDiFXControl_1_1Client.html#a42860cd594f3d54217fdf37209fb0728" title="Select a list of messages that the server should relay. ">DiFXControl.Client.messageSelection()</a>, the class provided by <a class="el" href="namespaceDiFXControl.html#a36503727c519a2be527c90870d699bdf" title="Function to parse a DiFX message given its XML data. ">DiFXControl.parseXML()</a>, and a description of what (I think) they are used for (this is where the inaccuracies might appear).</p>
<p>Note that many of the message types were created (and are exclusively used for) communication with <em>guiServer</em>. These message types will probably <em>not</em> appear as UDP broadcasts.</p>
<table class="doxtable">
<tr>
<td>DifxLoadMessage </td><td><a class="el" href="classDiFXControl_1_1DifxLoadMessage.html" title="Class to contain a DifxLoadMessage. ">DiFXControl.DifxLoadMessage</a> </td><td>Transmitted by processors or Mark5's (from <em>mk5daemon</em>), shows CPU load, transmit and receive rate. </td></tr>
<tr>
<td>DifxAlertMessage </td><td><a class="el" href="classDiFXControl_1_1DifxAlertMessage.html" title="Class to contain a DifxAlertMessage. ">DiFXControl.DifxAlertMessage</a> </td><td>Transmits an "alert" associated with an <code>.input</code> file - presumably a running job. </td></tr>
<tr>
<td>Mark5StatusMessage </td><td><a class="el" href="classDiFXControl_1_1Mark5StatusMessage.html" title="Class to contain a Mark5StatusMessage. ">DiFXControl.Mark5StatusMessage</a> </td><td>Transmitted by Mark5 units (from <em>mk5daemon</em>), shows VNS's for mounted modules, scan number being worked on, etc. </td></tr>
<tr>
<td>DifxStatusMessage </td><td><a class="el" href="classDiFXControl_1_1DifxStatusMessage.html" title="Class to contain a DifxStatusMessage. ">DiFXControl.DifxStatusMessage</a> </td><td>Transmits the status of a running job (indentified by <code>.input</code> file name) including current MJD and start/stop MJDs (all of which allow you to get a rough completion percentage). </td></tr>
<tr>
<td>DifxInfoMessage </td><td><a class="el" href="classDiFXControl_1_1DifxInfoMessage.html" title="Class to contain a DifxInfoMessage. ">DiFXControl.DifxInfoMessage</a> </td><td>Contains a single piece of information in the form of a string. </td></tr>
<tr>
<td>DifxDatastreamMessage </td><td><em>not available</em> </td><td>Definition appears to be missing in <code>difxmessage.h</code>. Is this message in use? </td></tr>
<tr>
<td>DifxCommand </td><td><a class="el" href="classDiFXControl_1_1DifxCommandMessage.html" title="Class to contain a DifxCommandMessage. ">DiFXControl.DifxCommandMessage</a> </td><td>Contains a single command (which is just a string). </td></tr>
<tr>
<td>DifxParameter </td><td><a class="el" href="classDiFXControl_1_1DifxParameter.html" title="Class to contain a DifxParameter Message. ">DiFXControl.DifxParameter</a> </td><td>Transmits a single parameter name and value. </td></tr>
<tr>
<td>DifxStart </td><td><a class="el" href="classDiFXControl_1_1DifxStart.html" title="Class to contain a DifxStart Message. ">DiFXControl.DifxStart</a> </td><td>Instructs <em>guiServer</em> to start a job using its <code>.input</code> file name. </td></tr>
<tr>
<td>DifxStop </td><td><a class="el" href="classDiFXControl_1_1DifxStop.html" title="Class to contain a DifxStop Message. ">DiFXControl.DifxStop</a> </td><td>Instructs <em>guiServer</em> to try to stop a running job using the <code>.input</code> file name. I say "try" because it is often unsuccessful. </td></tr>
<tr>
<td>Mark5VersionMessage </td><td><a class="el" href="classDiFXControl_1_1Mark5VersionMessage.html" title="Class to contain a Mark5VersionMessage. ">DiFXControl.Mark5VersionMessage</a> </td><td>Contains information about a Mark5 unit - firmware versions, that sort of thing. </td></tr>
<tr>
<td>Mark5ConditionMessage </td><td><em>not available</em> </td><td>Deprecated </td></tr>
<tr>
<td>DifxTransientMessage </td><td><a class="el" href="classDiFXControl_1_1DifxTransientMessage.html" title="Class to contain a DifxTransientMessage. ">DiFXControl.DifxTransientMessage</a> </td><td>Used to tell Mk5daemon to copy some data at the end of the correlation to a disk file. </td></tr>
<tr>
<td>DifxSmartMessage </td><td><a class="el" href="classDiFXControl_1_1DifxSmartMessage.html" title="Class to contain a DifxSmartMessage. ">DiFXControl.DifxSmartMessage</a> </td><td>Contains <em>S.M.A.R.T.</em> information for one disk in a Mark5 module. Typically 8 such messages will be needed to convey results from the conditioning of one module. </td></tr>
<tr>
<td>Mark5DriveStatsMessage </td><td><a class="el" href="classDiFXControl_1_1Mark5DriveStatsMessage.html" title="Class to contain a Mark5DriveStatsMessage. ">DiFXControl.Mark5DriveStatsMessage</a> </td><td>Transmits drive statistics for Mark5 modules - serial numbers, VSNs, etc. </td></tr>
<tr>
<td>DifxDiagnosticMessage </td><td><a class="el" href="classDiFXControl_1_1DifxDiagnosticMessage.html" title="Class to contain a DifxDiagnosticMessage. ">DiFXControl.DifxDiagnosticMessage</a> </td><td>Used to pass out diagnostic-type info like buffer states. </td></tr>
<tr>
<td>DifxFileTransfer </td><td><a class="el" href="classDiFXControl_1_1DifxFileTransfer.html" title="Class to contain a DifxFileTransfer Message. ">DiFXControl.DifxFileTransfer</a> </td><td>Uses <em>guiServer</em> to grab the contents of a file from the DiFX server or push content into a named file on the DiFX server. </td></tr>
<tr>
<td>DifxFileOperation </td><td><a class="el" href="classDiFXControl_1_1DifxFileOperation.html" title="Class to contain a DifxFileOperation Message. ">DiFXControl.DifxFileOperation</a> </td><td>Tells <em>guiServer</em> to perform operations such as <em>mkdir</em>, <em>rmdir</em>, <em>ls</em> and <em>rm</em>. </td></tr>
<tr>
<td>DifxVex2DifxRun </td><td><a class="el" href="classDiFXControl_1_1DifxVex2DifxRun.html" title="Class to contain a DifxVex2DifxRun. ">DiFXControl.DifxVex2DifxRun</a> </td><td>Instructs <em>guiServer</em> to run the DiFX application <em>vex2difx</em>, which will create <code>.input</code> files out of <code>.vex</code> and <code>.v2d</code> files. </td></tr>
<tr>
<td>DifxMachinesDefinition </td><td><a class="el" href="classDiFXControl_1_1DifxMachinesDefinition.html" title="Class to contain a DifxMachinesDefinition Message. ">DiFXControl.DifxMachinesDefinition</a> </td><td>Instructs <em>guiServer</em> to build <code>.machines</code> and <code>.threads</code> files associated with a particular <code>.input</code> file. Developed for the GUI/guiServer interface. </td></tr>
<tr>
<td>DifxGetDirectory </td><td><a class="el" href="classDiFXControl_1_1DifxGetDirectory.html" title="Class to contain a DifxGetDirectory Message. ">DiFXControl.DifxGetDirectory</a> </td><td>Starts a session with <em>guiServer</em> to obtain the directory for a Mark5 module. </td></tr>
<tr>
<td>DifxMk5Control </td><td><a class="el" href="classDiFXControl_1_1DifxMk5Control.html" title="Class to contain a DifxMk5Control Message. ">DiFXControl.DifxMk5Control</a> </td><td>Tells <em>guiServer</em> to run <em>mk5control</em> for a specific task - this will in turn generate another message type. </td></tr>
<tr>
<td>DifxMark5Copy </td><td><a class="el" href="classDiFXControl_1_1DifxMark5Copy.html" title="Class to contain a DifxMark5Copy Message. ">DiFXControl.DifxMark5Copy</a> </td><td>Tells <em>guiServer</em> to run <em>mk5cp</em> to make file copies of Mark5 data. </td></tr>
</table>
<p>The <a class="el" href="group__difxmessages.html">DiFXMessages</a> example program shows how to collect and parse all of the different DiFX message types.</p>
<h1><a class="anchor" id="creatingJobs"></a>
Creating New Jobs</h1>
<h1><a class="anchor" id="jobControl"></a>
Starting, Stopping and Monitoring DiFX Jobs</h1>
<p>All job control is done using the <a class="el" href="classDiFXJobControl_1_1Client.html" title="Class used to start and stop jobs. ">DiFXJobControl.Client</a> class, which inherits the <a class="el" href="classDiFXControl_1_1Client.html" title="Class for creating and manipulating a client connection to the DiFX server. ">DiFXControl.Client</a> class. Creating an instance of this class for job control is done in a pretty standard way.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">import</span> DiFXJobControl</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;difx = <a class="code" href="classDiFXJobControl_1_1Client.html">DiFXJobControl.Client</a>()</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;difx.connect()</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;difx.monitor()</div>
</div><!-- fragment --><p>While this class inherits the <a class="el" href="classDiFXControl_1_1Client.html" title="Class for creating and manipulating a client connection to the DiFX server. ">DiFXControl.Client</a> class, it more complex than the <a class="el" href="taskSpecific.html">Task-Specific Classes</a>, and its methods cannot be called by the <a class="el" href="classDiFXControl_1_1Client.html" title="Class for creating and manipulating a client connection to the DiFX server. ">DiFXControl.Client</a> class.</p>
<h2><a class="anchor" id="jobControl_inputFile"></a>
Identifying a Job Using the .input File</h2>
<p>Each job on the DiFX server can be uniquely identified by the full path to its <code>.input</code> file. The <code>.input</code> file (along with some other files) contains a full description of a job, and must exist for DiFX to process it. The <code>.input</code> file always has the extension ".input". It is created from the <code>.vex</code> and <code>.vex</code> files by <em>vex2difx</em>.</p>
<p>The <a class="el" href="classDiFXJobControl_1_1Client.html" title="Class used to start and stop jobs. ">DiFXJobControl.Client</a> class uses the full path of the <code>.input</code> file to refer control and monitoring instructions to the correct job. Before you start controlling a job, you must give the class an existing <code>.input</code> file to work with.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  Give the client class the name of the .input file for our job</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;difx.inputFile( <span class="stringliteral">&quot;/the/full/path/to/the/job.input&quot;</span> )</div>
</div><!-- fragment --><h2><a class="anchor" id="jobControl_machines"></a>
Defining Data Sources and Processors</h2>
<p>To run on a multi-processor system, DiFX requires a list of the processing nodes that will be used as data sources, those that will be used for processing along with the number of processing threads to run on each, and the name of the node that will serve as the manager of the others, or the "head node". These specifications are contained in two files on the DiFX server with the extensions ".machines" and ".threads". If these files exist for your <code>.input</code> file you can download the content of them using the <a class="el" href="classDiFXJobControl_1_1Client.html#a48bfef2fa264d965ee20c97a01b35af4" title="Use existing .machines and .threads files to fill current structures. ">DiFXJobControl.Client.getMachines()</a> method and examine it by using the <a class="el" href="classDiFXJobControl_1_1Client.html#a2892d327ada2f664783aeb772939ab07" title="Return the name of the head node. ">DiFXJobControl.Client.headNode()</a>, <a class="el" href="classDiFXJobControl_1_1Client.html#a02dabc709893aaf6472e92bb668274a1" title="Return a list of the data source nodes. ">DiFXJobControl.Client.dataSources()</a> and <a class="el" href="classDiFXJobControl_1_1Client.html#a59101b593af0a24235862f550367c25d" title="Return a list of the processors and threads. ">DiFXJobControl.Client.processors()</a> methods.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  Get the content of the .machines and .threads files</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;difx.getMachines()</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">#  The head node is stored as a string</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keywordflow">print</span> difx.headNode()</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">#  The data sources are stored as a list of strings</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keywordflow">for</span> node <span class="keywordflow">in</span> difx.dataSources():</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    <span class="keywordflow">print</span> node</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;    </div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">#  The processors are stored as a list of tuples that have node names and threads</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keywordflow">for</span> node <span class="keywordflow">in</span> difx.processors():</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    <span class="keywordflow">print</span> node[0] + <span class="stringliteral">&quot;  &quot;</span> + str( node[1] )</div>
</div><!-- fragment --><p>You can change the node names and threads in these lists using the <a class="el" href="classDiFXJobControl_1_1Client.html#a2892d327ada2f664783aeb772939ab07" title="Return the name of the head node. ">DiFXJobControl.Client.headNode()</a>, <a class="el" href="classDiFXJobControl_1_1Client.html#a53a42767f430886e7e0522cd822a4a93" title="Add a data source to the list of data sources. ">DiFXJobControl.Client.addDataSource()</a> and <a class="el" href="classDiFXJobControl_1_1Client.html#aeb7200a3e62b431017b387407261d42e" title="Add a processor to the list of processors. ">DiFXJobControl.Client.addProcessor()</a> methods, or clear them completely using the <a class="el" href="classDiFXJobControl_1_1Client.html#a04b24c3056aaf31455f0cc2fd3ce8df8" title="Remove all data source definitions. ">DiFXJobControl.Client.clearDataSources()</a> and <a class="el" href="classDiFXJobControl_1_1Client.html#a321245c963ef36b7d759b4f4e7918eac" title="Remove all processor definitions. ">DiFXJobControl.Client.clearProcessors()</a> methods.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  change the head node</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;difx.headNode( <span class="stringliteral">&quot;myHeadNode&quot;</span> )</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">#  empty the data source list</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;difx.clearDataSources()</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">#  add a few data sources of our own</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;difx.addDataSource( <span class="stringliteral">&quot;myDataSource1&quot;</span> )</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;difx.addDataSource( <span class="stringliteral">&quot;myDataSource2&quot;</span> )</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">#  add a few processors to the existing list, along with the threads to be used by</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">#  each -- we are not emptying the list first so these are added to whatever was there.</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;difx.addProcessor( <span class="stringliteral">&quot;myProcessor1&quot;</span>, 10 )</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;difx.addProcessor( <span class="stringliteral">&quot;myProcessor2&quot;</span>, 8 )</div>
</div><!-- fragment --><p>The above functions change the lists of nodes in the <a class="el" href="classDiFXJobControl_1_1Client.html" title="Class used to start and stop jobs. ">DiFXJobControl.Client</a> class, but the <code>.machines</code> and <code>.threads</code> files on the DiFX server aren't changed until you run the <a class="el" href="classDiFXJobControl_1_1Client.html#a37c113377ddc38639367734fe4a94e79" title="Send a machines definition to the server. ">DiFXJobControl.Client.defineMachines()</a> method.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  create new .machines and .threads files using our definitions</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;difx.defineMachines()</div>
</div><!-- fragment --><h2><a class="anchor" id="jobControl_start"></a>
Running a Job and Monitoring Progress</h2>
<p>Once the <code>.input</code> file is defined and the <code>.machines</code> and <code>.threads</code> files are in place, starting a job is a simple matter of calling the <a class="el" href="classDiFXJobControl_1_1Client.html#acb5008deffa04a1be06662c98e16bb44" title="Send a command to start a job to the server. ">DiFXJobControl.Client.start()</a> method. Calling the method without arguments will make it return only after the job is complete. In this case we give the client a long "time out" period using the <a class="el" href="classDiFXControl_1_1Client.html#afe0877bac019ea92bbf8f04202ae9c60" title="Set the global wait time. ">DiFXControl.Client.waitTime()</a> method. This keeps the start command from returning prematurely (which it may do if your system is slow to spawn a job - the wait time is something that has to be experimented with to tailor it for each system).</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  Set a very long wait time so we don&#39;t time out waiting for the job to start</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;difx.waitTime( 300.0 )</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">#  Start the job - method will return when it is done</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;difx.start()</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="keywordflow">print</span> <span class="stringliteral">&quot;job done!&quot;</span></div>
</div><!-- fragment --><p>Alternatively you can start a job such that the method returns immediately. This will allow you to do other things, but you won't necessarily know when it is done unless you make other monitoring arrangements. No need to mess with the wait time in this case.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  Start the job - method will return immediately</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;difx.start( <span class="keyword">False</span> )</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="keywordflow">print</span> <span class="stringliteral">&quot;job started!&quot;</span></div>
</div><!-- fragment --><h3><a class="anchor" id="monitor_progress"></a>
How Can I See What is Going On?</h3>
<p>If you run a job using <a class="el" href="classDiFXJobControl_1_1Client.html#acb5008deffa04a1be06662c98e16bb44" title="Send a command to start a job to the server. ">DiFXJobControl.Client.start()</a> it will run silently, and except for returning when it is done (or failed), it won't tell you much about what is going on (you can also throw away that paltry piece of information by telling <a class="el" href="classDiFXJobControl_1_1Client.html#acb5008deffa04a1be06662c98e16bb44" title="Send a command to start a job to the server. ">DiFXJobControl.Client.start()</a> to return immediately). However, there is more information available.</p>
<p>When <em>guiServer</em> runs a job in response to the <a class="el" href="classDiFXJobControl_1_1Client.html#acb5008deffa04a1be06662c98e16bb44" title="Send a command to start a job to the server. ">DiFXJobControl.Client.start()</a> method, it collects all output to <em>stdout</em> and <em>stderr</em> and transmits these data back to the client where they are treated as "messages", "warnings", and "errors". These data can be monitored by setting appropriate callback functions (see <a class="el" href="howToUse.html#feedback">Collecting Information Provided by Running Processes</a>).</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  Callback functions for messages, warnings, and errors.</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">def </span>messageCallback( argstr ):</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    <span class="keywordflow">print</span> str( argstr )</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    </div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keyword">def </span>warningCallback( argstr ):</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&quot;WARNING: &quot;</span> + str( argstr )</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    </div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keyword">def </span>errorCallback( argstr ):</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&quot;ERROR: &quot;</span> + str( argstr )</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;    </div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">#  Assign the callbacks</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;difx.messageCallback( messageCallback )</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;difx.warningCallback( warningCallback )</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;difx.errorCallback( errorCallback )</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">#  Start the job - output will be printed by the callbacks</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;difx.start()</div>
</div><!-- fragment --><p><em>GuiServer</em> provides some other feedback as well, mostly in the form of problems encountered when trying to start a job. The client translates these data into messages, warnings, and errors as well, as it sees fit.</p>
<p>You can also directly gather the feedback from <em>guiServer</em> yourself using your own assigned callback. See the <a class="el" href="classDiFXJobControl_1_1Client.html#aab0b14a35c16a3ca8d9f9508daeac591" title="Set your own callback for responses to start activities. ">DiFXJobControl.Client.setStartCallback()</a> method for more information.</p>
<p>The trouble with monitoring messages, warnings, and errors is that DiFX simply does not provide much information to <em>stdout</em> and <em>stderr</em> while a job is running (there is a burst of information when it starts, but nothing after that). A slightly trickier approach to viewing the progress of a job, but one that will provide you with more information, is to monitor DiFX message traffic, which is described in the <a class="el" href="howToUse.html#messages">Monitoring DiFX Messages</a> section above. There are several DiFX UDP message types that contain information related to specific jobs (see the <a class="el" href="group__difxbusy.html">DiFXBusy</a> example application), but for the following code example we will be collecting messages of the "DifxStatusMessage" type from which we can compute a (rough) completion percentage.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  Define a class to respond to messages</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">class </span>Responder:</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    <span class="keyword">def </span>__init__( self ):</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;        self.jobName = <span class="keywordtype">None</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;        self.jobProgress = 0</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    <span class="comment">#  Callback triggered when the monitoring client receives a new DiFX message.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    <span class="keyword">def </span>difxRelayCallback( self, data ):</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;        <span class="comment">#  Parse the message.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;        xmlDat = <a class="code" href="namespaceDiFXControl.html#a36503727c519a2be527c90870d699bdf">DiFXControl.parseXML</a>( data )</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;        <span class="comment">#  See if this is a message type we are interested in.</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;        <span class="keywordflow">if</span> xmlDat.typeStr == <span class="stringliteral">&quot;DifxStatusMessage&quot;</span>:</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;            <span class="comment">#  Make sure the identifier (job name) is one we are interested in.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;            <span class="keywordflow">if</span> self.jobName != <span class="keywordtype">None</span> <span class="keywordflow">and</span> xmlDat.identifier == self.jobName:</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;                <span class="comment">#  Compute a progress value.  The data for this might not be there, so we</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;                <span class="comment">#  have some default situations.</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;                <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;                    self.jobProgress = 100.0 * ( float( xmlDat.visibilityMJD ) - float( xmlDat.jobstartMJD ) ) / ( float( xmlDat.jobstopMJD ) - float( xmlDat.jobstartMJD ) )</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;                <span class="keywordflow">except</span>:  <span class="comment">#  Exception caused by failures of float conversions - because fields are empty</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;                    <span class="keywordflow">if</span> xmlDat.state == <span class="stringliteral">&quot;Done&quot;</span> <span class="keywordflow">or</span> xmlDat.state == <span class="stringliteral">&quot;MpiDone&quot;</span>:</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;                        self.jobProgress = 100</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;                    <span class="keywordflow">elif</span> xmlDat.state == <span class="stringliteral">&quot;Ending&quot;</span>:</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;                        <span class="comment">#  Ending state is annoying - use the job&#39;s known progress</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;                        <span class="keywordflow">pass</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;                    <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;                        self.jobProgress = 0</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;                <span class="comment">#  print the results</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;                <span class="keywordflow">print</span> xmlDat.state + <span class="stringliteral">&quot;   &quot;</span> + str( int( self.jobProgress ) ) + <span class="stringliteral">&quot;% complete&quot;</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;                </div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;...</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">#  Create a new Responder class instance</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;responder = Responder()</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment">#  Tell it what the job name is (which we generate from the full path to the .input file)</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;responder.jobName = inputFile[inputFile.rfind( <span class="stringliteral">&quot;/&quot;</span> ) + 1:inputFile.rfind( <span class="stringliteral">&quot;.&quot;</span> )]</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment">#  Add the callback in the responder class instance</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;difx.addRelayCallback( responder.difxRelayCallback )</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">#  Turn on packet &quot;relays&quot; - this causes guiServer to feed DiFX message traffic to the client</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;difx.relayPackets()</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">#  Start the job and watch the results</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;difx.start()</div>
</div><!-- fragment --><h2><a class="anchor" id="jobControl_stop"></a>
Stopping a Running Job</h2>
<p><em>GuiServer</em> uses <em>mpirun</em> to spawn a job, and has little control over it once it has been started. Once it has been started, a job will continue until completion (or failure), even if <em>guiServer</em> is killed. This can be annoying if you realize that a job is doing the wrong thing and wish it to stop consuming resources. The <a class="el" href="classDiFXJobControl_1_1Client.html#a992547ede1a41b80bbebc69813344206" title="Attempt to stop a running job. ">DiFXJobControl.Client.stop()</a> method can be used to attemp to stop a running job. Unlike <a class="el" href="classDiFXJobControl_1_1Client.html#acb5008deffa04a1be06662c98e16bb44" title="Send a command to start a job to the server. ">DiFXJobControl.Client.start()</a> it has an (optional) <code>.input</code> file argument.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  Stop the previously referenced .input file</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;difx.stop()</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">#  Stop some different job using its input file path</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;difx.stop( <span class="stringliteral">&quot;/full/path/to/other/file.input&quot;</span> )</div>
</div><!-- fragment --><p>The only problem with the <a class="el" href="classDiFXJobControl_1_1Client.html#a992547ede1a41b80bbebc69813344206" title="Attempt to stop a running job. ">DiFXJobControl.Client.stop()</a> method is that it often quite mysterously fails to work. Upon receipt of the stop request, <em>guiServer</em> will do everything in its power to stop a job, but often, and especially when some aspect of processing has become wedged (annoyingly the situation where you would most likely want to stop running), nothing happens.</p>
<h2><a class="anchor" id="jobControl_monitor"></a>
Monitoring the Data Output of a Running Job</h2>
<p>The <a class="el" href="classDiFXJobControl_1_1Client.html" title="Class used to start and stop jobs. ">DiFXJobControl.Client</a> class has the ability to collect real-time data products from a running job. This ability depends on the presence of the <em>monitor_server</em> application in the DiFX bin on the DiFX server (it doesn't have to be running - it just has to be there), and can only monitor one running job at a time (DiFX can run many simultaneously). The process is also a bit buggy.</p>
<p>Real time monitoring can be instructed to collect a number of data "products" for each frequency in a scan. As a time segment is processed within a scan, the data products will become available. The products themselves are described in detail in the <a class="el" href="classDiFXJobControl_1_1Client.html#ab512a9ec7721e216d499b7b77d63e02f" title="Get data products available for real time monitoring. ">DiFXJobControl.Client.getMonitorProducts()</a> method, but in brief summary they include: </p><ul>
<li>
Computed <b>amplitude</b> values for the segment </li>
<li>
Computed <b>phase</b> values for the segment </li>
<li>
Computed <b>lag</b> values, as well as <b>delay</b> and <b>signal-to-noise</b> for the segment </li>
<li>
Computed <b>mean amplitude</b> values for the accumulated scan up to the segment </li>
<li>
Computed <b>mean phase</b> values for the accumulated scan up to the segment </li>
<li>
Computed <b>mean lag</b> values, as well as <b>mean delay</b> and <b>mean signal-to-noise</b> for the accumulated scan up to the segment </li>
</ul>
<p>These data are obtained by callback functions that you must create and assign. The following code (with limited explanation) shows the collection of some real time data. </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  Define a callback for lag data</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">def </span>lagCallback():</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    <span class="comment">#  Print the array of lag data</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    <span class="keywordflow">print</span> difx.lag</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    <span class="comment">#  Print the delay and SNR</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    <span class="keywordflow">print</span> difx.meanLagDelay, difx.meanLagSnr</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">#  Create your class instance, define an .input file, etc.  </span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;...</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">#  Start the real time monitor</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;difx.startMonitor()</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">#  Generate a list of available data products.  This will give you</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">#  of &quot;product numbers&quot; that you put in a list (see below)</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;monProducts = difx.getMonitorProducts()</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">#  Request a list of product using their product numbers (see above).</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">#  The numbers used here are arbitrary.  You can request any number of</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">#  products that you like.</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;difx.requestProducts( ( 3, 5, 8 ) )</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">#  Turn monitoring on - the job will now run with the real time monitoring</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;difx.runWithMonitor( <span class="keyword">True</span> )</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">#  Select your callbacks for one or more of the six product types.  We</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">#  are only interested in the accumulated lag values</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;difx.monitorDataCallbacks( <span class="keywordtype">None</span>, <span class="keywordtype">None</span>, <span class="keywordtype">None</span>, <span class="keywordtype">None</span>, <span class="keywordtype">None</span>, lagCallback )</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">#  Start the job - real time data will trigger the callback as each</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">#  segment is processed.</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;difx.start()</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">#  Do this when you are done.</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;difx.stopMonitor()</div>
</div><!-- fragment --><p>There are problems with the real time monitor that make it not quite ready for prime time. If multiple jobs are run in dequence <em>guiServer</em> will occasionally (or perhaps the word should be "eventually") crash. In addition, the <em>monitor_server</em> program will often not provide data after the first job and will need to be killed by hand. More work is necessary to clean this process up.</p>
<h1><a class="anchor" id="jobHistory"></a>
Obtaining the Run History of a Job</h1>
<p>Any job that has been run using <em>guiServer</em> or the <em>startdifx</em> script will add to a record of run-time activities and final run status to a <code>.difxlog</code> file (located in the same directory as the <code>.input</code> file). The <a class="el" href="classDiFXControl_1_1Client.html#a5ba9dc437b4188ef06578c0517e1b173" title="Get the &quot;status&quot; of a job or jobs using .input file path. ">DiFXJobControl.Client.jobStatus()</a> method can be used to trigger <em>guiServer</em> to parse a list of <code>.difxlog</code> files and return a description of their run history.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#  Get status information for a list of .input files - normal &quot;ls&quot; wildcards permitted.</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;statusInfo = difx.jobStatus( <span class="stringliteral">&quot;/full/path/to/*.input&quot;</span> )</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">#  Print the overall time stamp - first item in a returned tuple</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keywordflow">print</span> statusInfo[0]</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">#  Then results list - second item in the returned tuple</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keywordflow">if</span> statusInfo[1] == <span class="keywordtype">None</span>:</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&quot;No .input files found.&quot;</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;    </div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;    <span class="comment">#  Each item (corresponds to each requested .input file) is a tuple itself.</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    <span class="comment">#  Compose a line of output for each.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;    <span class="keywordflow">for</span> item <span class="keywordflow">in</span> statusInfo[1]:</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;        <span class="comment">#  First part of tuple is the .input file</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;        outStr = item[0] + <span class="stringliteral">&quot;      &quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;        <span class="comment">#  Second item of the tuple is yet another tuple, the second item of which</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;        <span class="comment">#  is the final status!</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;        outStr += item[1][1]</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;        <span class="keywordflow">print</span> outStr</div>
</div><!-- fragment --><p>The <code>.difxlog</code> file contains quite a bit of information about the run history of a job, but currently the <a class="el" href="classDiFXControl_1_1Client.html#a5ba9dc437b4188ef06578c0517e1b173" title="Get the &quot;status&quot; of a job or jobs using .input file path. ">DiFXJobControl.Client.jobStatus()</a> method will only return the most recent status of a job (never started, successful, failed, running, etc). This is useful information, but future expansion of the capability should be able to provide much more.</p>
<h1><a class="anchor" id="vsnStuff"></a>
Mark5-Specific Operations</h1>
<h2><a class="anchor" id="vsnStuff_mk5"></a>
Sending a Mark5 Command</h2>
<h2><a class="anchor" id="vsnStuff_directory"></a>
Obtaining the Directory of a Mark5 Module</h2>
<h2><a class="anchor" id="vsnStuff_filelist"></a>
Generating a New Mark5 "File List"</h2>
<h2><a class="anchor" id="vsnStuff_copy"></a>
Copying Data from a Mark5 Module</h2>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Dec 9 2015 16:23:23 for DiFX Python Interface by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
